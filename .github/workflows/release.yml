name: Release

on:
  push:
    tags:
      - 'v*' # 当推送以 v 开头的 tag 时触发
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    env:
      RUSTC_WRAPPER: sccache
      SCCACHE_GHA_ENABLED: "true"
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            artifact_name: fastsync-linux-amd64
            asset_name: fastsync-linux-amd64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: fastsync.exe
            asset_name: fastsync-windows-amd64.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install musl tools
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Enable sccache
        uses: mozilla-actions/sccache-action@v0.0.6
        continue-on-error: true

      - name: Verify sccache availability
        shell: bash
        run: |
          if ! sccache --start-server; then
            echo "Sccache unavailable; disabling RUSTC_WRAPPER."
            echo "RUSTC_WRAPPER=" >> "$GITHUB_ENV"
          fi

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}-${{ matrix.target }}
          add-job-id-key: false
          cache-workspace-crates: true

      - name: Build binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Build Debian package
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          VERSION=$(grep -m1 '^version' Cargo.toml | cut -d '"' -f2)
          DEB_DIR="packaging/linux"
          mkdir -p dist "$DEB_DIR/usr/bin"
          sed -i "s/^Version: .*/Version: ${VERSION}/" "$DEB_DIR/DEBIAN/control"
          cp "target/${{ matrix.target }}/release/fastsync" "$DEB_DIR/usr/bin/fastsync"
          chmod 755 "$DEB_DIR/usr/bin/fastsync"
          dpkg-deb --build "$DEB_DIR" "dist/fastsync_${VERSION}_amd64.deb"

      - name: Install cargo-wix
        if: matrix.os == 'windows-latest'
        run: cargo install cargo-wix

      - name: Install WiX Toolset
        if: matrix.os == 'windows-latest'
        run: |
          choco install wixtoolset --no-progress
          echo "C:\\Program Files (x86)\\WiX Toolset v3.11\\bin" >> $env:GITHUB_PATH

      - name: Build MSI Installer
        if: matrix.os == 'windows-latest'
        run: cargo wix --no-build --target ${{ matrix.target }} --nocapture

      - name: Prepare Assets
        shell: bash
        run: |
          mkdir -p dist
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            cp target/${{ matrix.target }}/release/fastsync.exe dist/fastsync.exe
            cp target/wix/*.msi dist/ 2>/dev/null || true
            cd dist && 7z a ../fastsync-windows-x64.zip fastsync.exe && cd ..
          else
            cp target/${{ matrix.target }}/release/fastsync dist/fastsync
            cd dist && tar -czvf ../fastsync-linux-x64.tar.gz fastsync && cd ..
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            fastsync-*.zip
            fastsync-*.tar.gz
            dist/*.msi
            dist/*.deb

  create-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    env:
      R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
      R2_BUCKET: ${{ secrets.R2_BUCKET }}
      R2_PUBLIC_BASE_URL: ${{ secrets.R2_PUBLIC_BASE_URL }}
      AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts/

      - name: Install AWS CLI
        if: env.R2_ENDPOINT != '' && env.R2_BUCKET != ''
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y unzip
          curl -sSL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install

      - name: Upload artifacts to R2
        if: env.R2_ENDPOINT != '' && env.R2_BUCKET != ''
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          DEST_TAG="s3://${R2_BUCKET}/releases/download/${TAG}"
          DEST_LATEST="s3://${R2_BUCKET}/releases/latest/download"
          find artifacts -type f \( -name "*.zip" -o -name "*.tar.gz" -o -name "*.msi" -o -name "*.deb" \) -print0 | while IFS= read -r -d '' f; do
            aws s3 cp "$f" "${DEST_TAG}/$(basename "$f")" --endpoint-url "$R2_ENDPOINT" --no-progress
            aws s3 cp "$f" "${DEST_LATEST}/$(basename "$f")" --endpoint-url "$R2_ENDPOINT" --no-progress
          done

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
            artifacts/**/*.msi
            artifacts/**/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
